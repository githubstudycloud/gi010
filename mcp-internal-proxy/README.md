# 内网 AI CLI 代理架构设计

针对企业内网环境，实现 Claude Code / Codex CLI / Gemini CLI 的统一代理接入方案。

## 目录

- [问题分析](#问题分析)
- [API 格式差异](#api-格式差异)
- [架构设计](#架构设计)
- [为什么这样设计](#为什么这样设计)
- [怎么做](#怎么做)
- [最佳实践方案](#最佳实践方案)

---

## 问题分析

### 核心挑战

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           问题全景图                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │
│  │ Claude Code │     │  Codex CLI  │     │ Gemini CLI  │                   │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘                   │
│         │                   │                   │                          │
│         ▼                   ▼                   ▼                          │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │
│  │ Anthropic   │     │ ChatGPT     │     │ Gemini      │                   │
│  │ Messages    │     │ Backend-API │     │ API         │                   │
│  │ API 格式    │     │ 私有格式     │     │ 格式        │                   │
│  │             │     │             │     │             │                   │
│  │ /v1/messages│     │ /backend-api│     │ /v1/...     │                   │
│  │             │     │ /codex/     │     │             │                   │
│  └─────────────┘     └─────────────┘     └─────────────┘                   │
│         │                   │                   │                          │
│         │         ┌────────┴────────┐          │                          │
│         │         │                 │          │                          │
│         ▼         ▼                 ▼          ▼                          │
│  ┌───────────────────────────────────────────────────────┐                │
│  │                    问题清单                            │                │
│  │                                                       │                │
│  │  1. API 格式不同：三种 CLI 使用完全不同的 API 格式      │                │
│  │  2. 认证方式不同：API Key / OAuth / Session Token      │                │
│  │  3. 私有端点：Codex 使用非公开的 ChatGPT 后端 API       │                │
│  │  4. 客户端信息泄露：原始请求暴露客户端环境信息          │                │
│  │  5. 内网隔离：无法直接访问外网 API 服务器               │                │
│  │  6. 模型切换：希望用内部模型替代外部模型               │                │
│  │                                                       │                │
│  └───────────────────────────────────────────────────────┘                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 你的需求

1. **内网环境**: 出口通过公司转发渠道
2. **自定义 API 大模型**: 使用本地/内部部署的模型
3. **Docker 部署**: 内网主机部署，团队共用
4. **隐藏客户端信息**: 代理不透传实际客户端信息到服务端

---

## API 格式差异

### 三大 CLI 的 API 对比

| 特性 | Claude Code | Codex CLI | Gemini CLI |
|------|-------------|-----------|------------|
| **API 端点** | `api.anthropic.com/v1/messages` | `chatgpt.com/backend-api/codex/responses` | `generativelanguage.googleapis.com` |
| **API 格式** | Anthropic Messages API | 私有 ChatGPT Backend API | Google AI API |
| **认证方式** | `x-api-key` Header | OAuth2 PKCE (ChatGPT 账户) | API Key |
| **请求格式** | `{"messages": [...], "model": "..."}` | 专有格式 (含 instructions) | Google 特有格式 |
| **流式响应** | SSE (`stream: true`) | SSE | SSE |
| **是否公开** | 公开文档 | **私有未公开** | 公开文档 |

### Claude Code API 格式

```json
// 端点: POST https://api.anthropic.com/v1/messages
// Headers:
//   x-api-key: $ANTHROPIC_API_KEY
//   anthropic-version: 2023-06-01
//   content-type: application/json

{
  "model": "claude-sonnet-4-20250514",
  "max_tokens": 4096,
  "messages": [
    {"role": "user", "content": "Hello"}
  ],
  "system": "You are a helpful assistant",
  "stream": true
}
```

### Codex CLI API 格式 (私有)

```json
// 端点: POST https://chatgpt.com/backend-api/codex/responses
// 认证: OAuth2 PKCE (通过 ChatGPT 账户登录)
// 注意: 这是私有 API，格式可能变化

{
  "model": "gpt-5-codex-mini",
  "instructions": "...(内置指令)...",
  "messages": [
    {"role": "developer", "content": "..."},
    {"role": "user", "content": "Hello"}
  ]
}
```

### Gemini CLI API 格式

```json
// 端点: POST https://generativelanguage.googleapis.com/v1/models/{model}:generateContent
// Headers:
//   x-goog-api-key: $GOOGLE_API_KEY

{
  "contents": [
    {"role": "user", "parts": [{"text": "Hello"}]}
  ],
  "generationConfig": {
    "maxOutputTokens": 4096
  }
}
```

### 格式转换关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          API 格式转换关系                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Anthropic Format          OpenAI Format           Google Format            │
│  ┌─────────────┐          ┌─────────────┐         ┌─────────────┐          │
│  │ messages:   │          │ messages:   │         │ contents:   │          │
│  │ [           │   ←→     │ [           │   ←→    │ [           │          │
│  │  {role,     │          │  {role,     │         │  {role,     │          │
│  │   content}  │          │   content}  │         │   parts}    │          │
│  │ ]           │          │ ]           │         │ ]           │          │
│  │             │          │             │         │             │          │
│  │ model:      │          │ model:      │         │ model in    │          │
│  │ "claude-x"  │          │ "gpt-x"     │         │ URL path    │          │
│  │             │          │             │         │             │          │
│  │ max_tokens  │          │ max_tokens  │         │ maxOutput   │          │
│  │             │          │             │         │ Tokens      │          │
│  └─────────────┘          └─────────────┘         └─────────────┘          │
│         │                       │                       │                   │
│         │                       │                       │                   │
│         └───────────────────────┼───────────────────────┘                   │
│                                 │                                           │
│                                 ▼                                           │
│                    ┌─────────────────────┐                                  │
│                    │    需要代理层进行    │                                  │
│                    │    格式双向转换      │                                  │
│                    └─────────────────────┘                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 架构设计

### 完整架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              内网代理架构                                            │
│                                                                                     │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │                           开发者工作站层                                        │ │
│  │                                                                               │ │
│  │  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                    │ │
│  │  │  开发者 A     │    │  开发者 B     │    │  开发者 C     │                    │ │
│  │  │              │    │              │    │              │                    │ │
│  │  │ Claude Code  │    │ Codex CLI    │    │ Gemini CLI   │                    │ │
│  │  │     ↓        │    │     ↓        │    │     ↓        │                    │ │
│  │  │ 设置环境变量  │    │ 设置代理     │    │ 设置代理     │                    │ │
│  │  │ ANTHROPIC_   │    │ HTTP(S)_    │    │ GEMINI_API_ │                    │ │
│  │  │ BASE_URL     │    │ PROXY       │    │ HOST        │                    │ │
│  │  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘                    │ │
│  │         │                   │                   │                            │ │
│  └─────────┼───────────────────┼───────────────────┼────────────────────────────┘ │
│            │                   │                   │                              │
│            │      内网 HTTP 请求 (各自格式)         │                              │
│            │                   │                   │                              │
│            ▼                   ▼                   ▼                              │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │                      统一代理网关层 (Docker)                                   │ │
│  │                      192.168.x.100                                            │ │
│  │                                                                               │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                        入口路由 (Nginx/Traefik)                          │ │ │
│  │  │                              :443 / :80                                  │ │ │
│  │  │                                                                         │ │ │
│  │  │   /v1/messages/* → Claude Proxy                                        │ │ │
│  │  │   /backend-api/* → Codex Proxy                                         │ │ │
│  │  │   /v1/models/*   → Gemini Proxy                                        │ │ │
│  │  │   /v1/chat/*     → OpenAI Compatible (LiteLLM)                         │ │ │
│  │  └─────────────────────────────────────────────────────────────────────────┘ │ │
│  │                                    │                                         │ │
│  │         ┌──────────────────────────┼──────────────────────────┐             │ │
│  │         │                          │                          │             │ │
│  │         ▼                          ▼                          ▼             │ │
│  │  ┌─────────────┐           ┌─────────────┐           ┌─────────────┐       │ │
│  │  │Claude Proxy │           │Codex Proxy  │           │Gemini Proxy │       │ │
│  │  │ (ccproxy/   │           │ (ccproxy-   │           │ (geminicli  │       │ │
│  │  │  litellm)   │           │  api)       │           │  2api)      │       │ │
│  │  │             │           │             │           │             │       │ │
│  │  │ Anthropic→  │           │ ChatGPT→    │           │ Google→     │       │ │
│  │  │ OpenAI格式  │           │ 内部格式    │           │ OpenAI格式  │       │ │
│  │  │  :8081      │           │  :8082      │           │  :8083      │       │ │
│  │  └──────┬──────┘           └──────┬──────┘           └──────┬──────┘       │ │
│  │         │                         │                         │              │ │
│  │         └─────────────────────────┼─────────────────────────┘              │ │
│  │                                   │                                        │ │
│  │                                   ▼                                        │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │ │
│  │  │                   LLM 统一网关 (LiteLLM Proxy)                       │  │ │
│  │  │                           :4000                                      │  │ │
│  │  │                                                                      │  │ │
│  │  │   功能:                                                              │  │ │
│  │  │   - 接收 OpenAI 格式请求                                             │  │ │
│  │  │   - 路由到不同后端模型                                               │  │ │
│  │  │   - 隐藏客户端信息 (重写 Headers)                                    │  │ │
│  │  │   - 统一认证管理                                                     │  │ │
│  │  │   - 访问日志和审计                                                   │  │ │
│  │  └─────────────────────────────────────────────────────────────────────┘  │ │
│  │                                   │                                        │ │
│  └───────────────────────────────────┼────────────────────────────────────────┘ │
│                                      │                                          │
│  ┌───────────────────────────────────┼────────────────────────────────────────┐ │
│  │                              模型服务层                                     │ │
│  │                                   │                                        │ │
│  │         ┌─────────────────────────┼─────────────────────────┐             │ │
│  │         │                         │                         │             │ │
│  │         ▼                         ▼                         ▼             │ │
│  │  ┌─────────────┐           ┌─────────────┐           ┌─────────────┐      │ │
│  │  │   Ollama    │           │  自定义 API  │           │ 外部 API    │      │ │
│  │  │  (本地LLM)  │           │   大模型     │           │ (可选转发)  │      │ │
│  │  │             │           │             │           │             │      │ │
│  │  │ - Qwen      │           │ - 公司内部   │           │ - OpenAI    │      │ │
│  │  │ - DeepSeek  │           │   部署的     │           │ - Anthropic │      │ │
│  │  │ - Llama     │           │   模型服务   │           │ - Google    │      │ │
│  │  │  :11434     │           │  :8000       │           │ (via 公司   │      │ │
│  │  │             │           │             │           │  出口代理)  │      │ │
│  │  └─────────────┘           └─────────────┘           └─────────────┘      │ │
│  │                                                                            │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

### 客户端信息隐藏流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        客户端信息隐藏机制                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  原始请求 (客户端)                     代理后请求 (到后端)                       │
│  ┌─────────────────────────┐          ┌─────────────────────────┐              │
│  │ Headers:                │          │ Headers:                │              │
│  │   User-Agent: Claude..  │    →     │   User-Agent: Gateway/  │              │
│  │   X-Real-IP: 10.0.0.5   │   代理   │                1.0      │              │
│  │   X-Forwarded-For: ...  │   重写   │   (移除所有客户端标识)   │              │
│  │   x-stainless-...: ...  │          │                         │              │
│  │   anthropic-beta: ...   │          │   Authorization: Bearer │              │
│  │                         │          │     <统一服务账号>       │              │
│  │ Body:                   │          │                         │              │
│  │   (原始请求体)           │          │ Body:                   │              │
│  │                         │          │   (格式转换后的请求体)   │              │
│  └─────────────────────────┘          └─────────────────────────┘              │
│                                                                                 │
│  关键点:                                                                        │
│  1. 移除所有 X-* 客户端标识头                                                   │
│  2. 重写 User-Agent 为统一网关标识                                              │
│  3. 使用服务账号认证，不透传用户 API Key                                        │
│  4. 记录原始客户端信息到内部日志（不发送到后端）                                │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 为什么这样设计

### 1. 为什么需要多个专用代理？

```
┌─────────────────────────────────────────────────────────────────┐
│  问题: 单一代理无法处理所有 CLI                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Claude Code:                                                   │
│  ├─ 使用 Anthropic Messages API 格式                            │
│  ├─ 需要 x-api-key + anthropic-version headers                 │
│  └─ ccproxy / LiteLLM 可以转换                                  │
│                                                                 │
│  Codex CLI:                                                     │
│  ├─ 使用 ChatGPT 私有 Backend API                               │
│  ├─ 需要 OAuth2 PKCE 认证 (不是简单 API Key)                    │
│  ├─ 有特殊的 instructions 注入机制                              │
│  └─ 需要专门的 ccproxy-api 处理                                 │
│                                                                 │
│  Gemini CLI:                                                    │
│  ├─ 使用 Google AI API 格式                                     │
│  ├─ 支持 GEMINI_API_HOST 自定义端点                             │
│  └─ geminicli2api 可以转换为 OpenAI 格式                        │
│                                                                 │
│  结论: 需要针对每种 CLI 的专用代理 + 统一后端                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2. 为什么用 LiteLLM 作为统一后端？

| 对比项 | 直接转发 | LiteLLM 统一网关 |
|--------|----------|------------------|
| 格式转换 | 每个代理单独实现 | LiteLLM 统一处理 100+ 模型 |
| 模型切换 | 需要修改每个代理 | 配置文件一处修改 |
| 负载均衡 | 需要额外实现 | 内置支持 |
| 认证管理 | 分散管理 | 集中的 API Key 管理 |
| 成本追踪 | 无 | 内置使用量统计 |
| 客户端隐藏 | 需要单独实现 | 配置统一 Headers |

### 3. 为什么 Codex CLI 特殊处理？

```
┌─────────────────────────────────────────────────────────────────┐
│  Codex CLI 的特殊性                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 私有 API 端点                                                │
│     - 端点: chatgpt.com/backend-api/codex/responses            │
│     - 非公开文档，格式可能随时变化                               │
│     - 专为 Codex CLI 设计                                       │
│                                                                 │
│  2. 特殊认证机制                                                 │
│     - 使用 OAuth2 PKCE 流程                                     │
│     - 绑定 ChatGPT Plus/Pro 订阅                                │
│     - 不是简单的 API Key 认证                                   │
│                                                                 │
│  3. 内置指令注入                                                 │
│     - API 要求包含特定 instructions                             │
│     - 缺少这些指令 API 会拒绝请求                               │
│                                                                 │
│  4. 解决方案                                                     │
│     ┌────────────────────────────────────────────┐              │
│     │  方案 A: ccproxy-api                        │              │
│     │  - 完整反向代理 ChatGPT Backend API        │              │
│     │  - 使用用户自己的 ChatGPT 登录              │              │
│     │  - 支持会话管理                             │              │
│     └────────────────────────────────────────────┘              │
│                                                                 │
│     ┌────────────────────────────────────────────┐              │
│     │  方案 B: 使用 GPT-5-Codex API Key           │              │
│     │  - 2025年9月后支持 API Key 访问             │              │
│     │  - 通过标准 OpenAI API 调用                 │              │
│     │  - 可以用 LiteLLM 统一管理                  │              │
│     └────────────────────────────────────────────┘              │
│                                                                 │
│     ┌────────────────────────────────────────────┐              │
│     │  方案 C: 用内部模型替代 (推荐内网)          │              │
│     │  - 配置 HTTP_PROXY 指向内部代理             │              │
│     │  - 代理返回内部模型响应                     │              │
│     │  - 完全不依赖外部 Codex API                 │              │
│     └────────────────────────────────────────────┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4. 信息隐藏的必要性

```
┌─────────────────────────────────────────────────────────────────┐
│  为什么需要隐藏客户端信息？                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  原始请求会泄露:                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ User-Agent: claude-code/1.0.0 (Darwin; arm64)           │   │
│  │ x-stainless-arch: arm64                                 │   │
│  │ x-stainless-os: MacOS                                   │   │
│  │ x-stainless-runtime: node                               │   │
│  │ x-stainless-runtime-version: v20.0.0                    │   │
│  │ X-Real-IP: 10.0.0.5                                     │   │
│  │ X-Forwarded-For: 10.0.0.5, 192.168.1.1                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  风险:                                                          │
│  - 暴露内部 IP 地址结构                                         │
│  - 暴露开发者使用的工具和版本                                   │
│  - 暴露操作系统和硬件架构                                       │
│  - 可能违反企业安全合规要求                                     │
│                                                                 │
│  代理后:                                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ User-Agent: Internal-AI-Gateway/1.0                     │   │
│  │ Authorization: Bearer <服务账号Token>                   │   │
│  │ (其他客户端标识头已移除)                                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 怎么做

### 实施路线图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              实施路线图                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  阶段 1: 基础设施          阶段 2: 代理层            阶段 3: 客户端配置          │
│  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐             │
│  │ 部署 Docker │    →     │ 部署各 CLI  │    →     │ 配置客户端  │             │
│  │ 环境和模型  │          │ 专用代理    │          │ 环境变量    │             │
│  └─────────────┘          └─────────────┘          └─────────────┘             │
│        │                        │                        │                      │
│        ▼                        ▼                        ▼                      │
│  - Docker/Compose         - Claude Proxy           - ANTHROPIC_BASE_URL        │
│  - Ollama 或内部 LLM      - Codex Proxy            - HTTP_PROXY                │
│  - LiteLLM Gateway        - Gemini Proxy           - GEMINI_API_HOST           │
│  - Nginx 入口             - Headers 清洗           - 测试验证                   │
│                                                                                 │
│  预计工时:                                                                      │
│  阶段 1: 2-4 小时                                                               │
│  阶段 2: 4-8 小时                                                               │
│  阶段 3: 1-2 小时 (每客户端)                                                    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 技术选型

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              技术选型决策                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         入口层                                           │   │
│  │                                                                         │   │
│  │   选项 A: Nginx (推荐简单场景)                                           │   │
│  │   - 配置简单                                                            │   │
│  │   - 路径路由                                                            │   │
│  │   - Headers 重写                                                        │   │
│  │                                                                         │   │
│  │   选项 B: Traefik (推荐动态场景)                                         │   │
│  │   - 自动服务发现                                                        │   │
│  │   - 动态配置                                                            │   │
│  │   - 原生 Docker 支持                                                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                       Claude Code 代理                                   │   │
│  │                                                                         │   │
│  │   选项 A: ccproxy (starbased-co) ★推荐                                  │   │
│  │   - 成熟稳定                                                            │   │
│  │   - 支持多模型路由                                                      │   │
│  │   - 规则引擎                                                            │   │
│  │                                                                         │   │
│  │   选项 B: claude-code-proxy (litellm based)                             │   │
│  │   - 基于 LiteLLM                                                        │   │
│  │   - 格式转换完善                                                        │   │
│  │                                                                         │   │
│  │   选项 C: LiteLLM 直接支持 Anthropic 格式                               │   │
│  │   - 原生支持 /v1/messages                                               │   │
│  │   - 无需额外代理                                                        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                       Codex CLI 代理                                     │   │
│  │                                                                         │   │
│  │   选项 A: 完全替换为内部模型 ★推荐内网                                  │   │
│  │   - 设置 HTTP_PROXY 指向内部代理                                        │   │
│  │   - 代理拦截并返回内部模型响应                                          │   │
│  │   - 不依赖外部 ChatGPT                                                  │   │
│  │                                                                         │   │
│  │   选项 B: ccproxy-api (需要 ChatGPT 账号)                               │   │
│  │   - 反向代理 ChatGPT Backend API                                        │   │
│  │   - 需要维护登录状态                                                    │   │
│  │                                                                         │   │
│  │   选项 C: 使用 GPT-5-Codex API Key                                      │   │
│  │   - 2025年9月后支持                                                     │   │
│  │   - 通过 LiteLLM 管理                                                   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                       Gemini CLI 代理                                    │   │
│  │                                                                         │   │
│  │   选项 A: geminicli2api ★推荐                                          │   │
│  │   - 转换为 OpenAI 格式                                                  │   │
│  │   - 支持流式响应                                                        │   │
│  │                                                                         │   │
│  │   选项 B: GEMINI_API_HOST 直接指向 LiteLLM                              │   │
│  │   - LiteLLM 支持 Gemini 格式                                            │   │
│  │   - 配置简单                                                            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                       LLM 后端                                           │   │
│  │                                                                         │   │
│  │   选项 A: Ollama (开源模型)                                             │   │
│  │   - Qwen, DeepSeek, Llama 等                                            │   │
│  │   - 本地 GPU 推理                                                       │   │
│  │                                                                         │   │
│  │   选项 B: 自定义内部 API                                                 │   │
│  │   - 公司自己部署的模型服务                                              │   │
│  │   - OpenAI 兼容格式                                                     │   │
│  │                                                                         │   │
│  │   选项 C: 混合 (Ollama + 内部 API + 外部转发)                           │   │
│  │   - LiteLLM 路由到不同后端                                              │   │
│  │   - 按需选择模型                                                        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 最佳实践方案

### 推荐方案: 完全内网自治

适用场景：内网隔离环境，使用自定义/本地模型，不依赖外部 API

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         推荐方案架构                                             │
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                             │
│  │ Claude Code │  │ Codex CLI   │  │ Gemini CLI  │                             │
│  │             │  │             │  │             │                             │
│  │ ANTHROPIC_  │  │ HTTPS_PROXY │  │ GEMINI_API_ │                             │
│  │ BASE_URL=   │  │ =proxy:443  │  │ HOST=proxy  │                             │
│  │ proxy:443   │  │             │  │             │                             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                             │
│         │                │                │                                     │
│         └────────────────┼────────────────┘                                     │
│                          │                                                      │
│                          ▼                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    Nginx + LiteLLM (统一网关)                            │   │
│  │                    192.168.x.100:443                                    │   │
│  │                                                                         │   │
│  │   功能:                                                                 │   │
│  │   ┌───────────────────────────────────────────────────────────────┐    │   │
│  │   │ 1. 路径路由                                                    │    │   │
│  │   │    /v1/messages  → LiteLLM (Anthropic 格式原生支持)           │    │   │
│  │   │    /v1/chat/*    → LiteLLM (OpenAI 格式)                      │    │   │
│  │   │    /*            → LiteLLM (通用)                             │    │   │
│  │   │                                                               │    │   │
│  │   │ 2. Headers 清洗 (Nginx)                                       │    │   │
│  │   │    - 移除 x-stainless-*, X-Real-IP, X-Forwarded-*            │    │   │
│  │   │    - 重写 User-Agent                                          │    │   │
│  │   │    - 使用服务账号认证                                         │    │   │
│  │   │                                                               │    │   │
│  │   │ 3. 访问日志                                                   │    │   │
│  │   │    - 记录请求来源 (内部审计)                                  │    │   │
│  │   │    - 不发送到后端                                             │    │   │
│  │   └───────────────────────────────────────────────────────────────┘    │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                          │                                                      │
│                          ▼                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         模型后端                                         │   │
│  │                                                                         │   │
│  │   ┌─────────────┐        ┌─────────────┐        ┌─────────────┐        │   │
│  │   │   Ollama    │        │ 内部 API    │        │ (可选)      │        │   │
│  │   │             │        │ 大模型      │        │ 外部转发    │        │   │
│  │   │ qwen2.5-    │        │             │        │             │        │   │
│  │   │ coder:32b   │        │ /v1/chat/*  │        │ 通过公司    │        │   │
│  │   │             │        │             │        │ 出口代理    │        │   │
│  │   │ deepseek-   │        │             │        │             │        │   │
│  │   │ coder-v2    │        │             │        │             │        │   │
│  │   └─────────────┘        └─────────────┘        └─────────────┘        │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

下一份文档将包含完整的配置文件和部署步骤。

---

*继续阅读: [DEPLOYMENT.md](./DEPLOYMENT.md) - 详细部署指南*
